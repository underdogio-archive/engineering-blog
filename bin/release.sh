#!/usr/bin/env bash
# Exit on the first error and echo commands
set -e
set -x

# Build our files
npm run build

# If there is GNU date available, then use it
# DEV: OS X doesn't support `--utc` (only `-u`) nor nanoseconds
date="date"
if which gdate &> /dev/null; then
  date="gdate"
fi

# Generate a timestamp for our release
version="$($date --utc +%Y%m%d.%H%M%S.%N)"

# Verify we only generater a numeric string (e.g. nanoseconds is supported)
# DEV: This is to prevent errors with OS X and BSD utilities
if echo "$version" | grep -E "[^0-9\.]"; then
  set +x
  echo "We found a non-numeric/non-period character in the version generated by \`$date\`" 1>&2
  echo "If you are on OS X, please see the \"OS X troubleshooting\" section in the README" 1>&2
  echo "Otheriwse, make sure your \`date\` utility is up to date" 1>&2
  exit 1
fi

# Version it via `npm` (bumps package.json, adds git commit, and git tag)
npm version "$version"

# Push our changes
git push origin release
git push origin --tags

# Publish the compiled version to `gh-pages`
npm run _deploy

# Silence extra noise
set +x

# Notify ourselves of the successful build
echo "underdogio.github.io has been built and deployed successfully as \"$version\""
echo "Please verify changes at http://underdogio.github.io/"
exit 0
